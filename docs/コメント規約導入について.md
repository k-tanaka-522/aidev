# コメント規約導入について

**作成日**: 2025-11-07
**目的**: AI開発を前提としたコード品質向上
**対象**: すべての開発者（人間・AI両方）

---

## 📋 概要

aiDevプロジェクトでは、**AI協業を前提としたコメント規約**を導入しました。

従来の「人間が読むためのコメント」に加えて、「AIがコンテキストを理解するためのコメント」を標準化することで、以下を実現します:

- ✅ AIによるコード理解の向上
- ✅ メンテナンス性の向上
- ✅ 設計意図の明確化
- ✅ チーム内での知識共有

---

## 🎯 基本方針

### すべての関数/メソッド/クラスに必須

以下の3点を日本語でコメントする:

1. **目的・理由**（なぜ）- この処理が必要な理由
2. **影響範囲**（どこに）- この処理がどこに影響するか
3. **前提条件・制約**（何が必要）- 実行条件、制約事項

---

## 📁 ドキュメント構造

### 全言語共通規約（マスター）

**場所**: [.claude/agents/coder/AGENT.md](.claude/agents/coder/AGENT.md)

**セクション**: `## 💬 コメント規約（全言語共通）`

**内容**:
- 原則・基本方針
- 必須コメント箇所
- 言語別コメント形式（TypeScript、Python、Go、C#）
- Good/Bad Examples
- コメント記述の注意点

**重要**: Coderエージェントはこのファイルを起動時に読み込むため、常にコメント規約を保持しています。

---

### 言語別規約（参照）

各言語の技術標準ドキュメントに、共通規約への参照を記載:

| 言語 | ファイル | セクション |
|------|---------|-----------|
| TypeScript | [.claude/docs/40_standards/42_typescript.md](.claude/docs/40_standards/42_typescript.md) | `### コメント規約` |
| Python | [.claude/docs/40_standards/41_python.md](.claude/docs/40_standards/41_python.md) | `### コメント規約` |
| Go | [.claude/docs/40_standards/44_go.md](.claude/docs/40_standards/44_go.md) | `### コメント規約` |
| C# | [.claude/docs/40_standards/43_csharp.md](.claude/docs/40_standards/43_csharp.md) | `## コメント規約` |

各ファイルには、AGENT.mdへの参照が記載されています。

---

## 💡 コメント例（TypeScript）

### ✅ Good（推奨）

```typescript
// 目的: ユーザー認証トークンの検証（セキュリティ要件: 認証必須API用）
// 影響: すべての認証必須APIエンドポイントで実行される
// 前提: JWT形式のトークンが必要、JWTシークレットが環境変数に設定済み
async function validateToken(token: string): Promise<User> {
  // JWTトークンのデコードと検証
  // 影響: 検証失敗時は401エラーを返し、後続処理は実行されない
  const decoded = jwt.verify(token, process.env.JWT_SECRET);

  // ユーザー情報の取得
  // 影響: DBアクセスが発生（キャッシュ未実装）
  const user = await db.findOne(User, { where: { id: decoded.userId } });

  if (!user) {
    throw new UnauthorizedError('User not found');
  }

  return user;
}
```

### ❌ Bad（不十分）

```typescript
// トークンを検証する
async function validateToken(token: string): Promise<User> {
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  const user = await db.findOne(User, { where: { id: decoded.userId } });

  if (!user) {
    throw new UnauthorizedError('User not found');
  }

  return user;
}
```

**問題点**:
- なぜこの処理が必要か不明
- どこに影響するか不明
- 前提条件が不明
- AIがコンテキストを理解できない

---

## 🔄 適用プロセス

### 新規コード作成時

1. **設計書を読む**
   - 詳細設計書の「実装方針」セクションを確認

2. **コメントを先に書く**
   - 関数/メソッドのシグネチャを定義
   - 3点（目的・影響・前提）をコメント記載

3. **実装する**
   - コメントに従って実装
   - 複雑なロジックには行コメントを追加

4. **レビュー**
   - コメントが3点を満たしているか確認

---

### 既存コード修正時

1. **既存コメントを確認**
   - 3点（目的・影響・前提）が記載されているか

2. **不足していれば追加**
   - コンテキストを理解した上でコメント追加

3. **変更内容を反映**
   - 影響範囲が変わった場合はコメント更新

---

## 🧠 なぜこの規約が必要か

### AI開発の特性

**問題**: LLMは「忘れる」
- コンテキストウィンドウの制約
- 長期セッションでの記憶喪失
- 複数ファイルをまたぐ処理の理解困難

**解決**: コードにコンテキストを埋め込む
- AIがコードを読むだけで意図を理解できる
- セッションをまたいでも一貫性を保てる
- 人間もメンテナンスしやすい

---

### 設計書との連携

**設計書**（docs/）:
- システム全体の構造
- ビジネスロジックの意図
- アーキテクチャ判断

**コメント**（コード内）:
- 個別関数の目的
- 具体的な影響範囲
- 実装の前提条件

**両方を組み合わせることで、完全なコンテキストを提供**

---

## 📊 メリット

### AI開発
- ✅ AIがコードの意図を正確に理解
- ✅ リファクタリング時の誤解を防止
- ✅ 設計書なしでもある程度の理解が可能

### 人間開発
- ✅ コードレビューが効率化
- ✅ 新規参加者のオンボーディングが容易
- ✅ メンテナンス時の理解が早い

### チーム全体
- ✅ 知識の属人化を防止
- ✅ 設計意図の共有が容易
- ✅ 品質の標準化

---

## ⚠️ 注意点

### コメントの更新を忘れない

**問題**: コードを修正したがコメントを更新しなかった
- コメントとコードが乖離
- AIが誤った判断をする

**対策**:
- コード修正時は必ずコメントも確認
- レビュー時にコメントの整合性をチェック

---

### 過剰なコメントは避ける

**問題**: 自明な処理にも詳細コメント
```typescript
// 1を足す
count = count + 1;  // ❌ Bad
```

**推奨**: 意図が重要な箇所のみコメント
```typescript
// ユーザー操作回数をカウント（analytics で使用）
// 影響: analytics_events テーブルに記録される
userActionCount++;  // ✅ Good
```

---

## 🚀 次のステップ

1. **既存コードへの適用**
   - 優先度: セキュリティ関連 > ビジネスロジック > ユーティリティ
   - 段階的に適用（一度にすべて変更しない）

2. **チームへの周知**
   - このREADMEを共有
   - AGENT.mdのコメント規約セクションを参照

3. **レビュープロセスへの組み込み**
   - PRレビュー時にコメント規約の遵守を確認
   - チェックリストに追加

---

## 📚 参考資料

- [Coderエージェント AGENT.md](.claude/agents/coder/AGENT.md) - マスター規約
- [TypeScript規約](.claude/docs/40_standards/42_typescript.md)
- [Python規約](.claude/docs/40_standards/41_python.md)
- [Go規約](.claude/docs/40_standards/44_go.md)
- [C#規約](.claude/docs/40_standards/43_csharp.md)

---

## 🤝 フィードバック

この規約は継続的に改善していきます。

- 使いにくい点
- 改善提案
- 追加すべき言語

などがあれば、チームで議論して更新しましょう。

---

**更新履歴**:
- 2025-11-07: 初版作成（全言語共通規約を AGENT.md に統合）
