# 2.3.5 製造物 - 基本設計書構成

## 目的

**基本設計書のテンプレート・記述方法**を提供します。

---

## 📋 基本設計書の目次構成

```markdown
# 基本設計書

## 1. はじめに
### 1.1 ドキュメント概要
### 1.2 対象読者
### 1.3 関連ドキュメント

## 2. システム概要
### 2.1 システム目的
### 2.2 システム機能概要
### 2.3 対象ユーザー

## 3. 制約事項・前提条件
### 3.1 技術的制約
### 3.2 ビジネス制約（予算・納期・人員）
### 3.3 外部依存（外部API・SaaS）
### 3.4 既存システムとの連携要件

## 4. アーキテクチャ設計
### 4.1 アーキテクチャパターン
#### 4.1.1 選定したパターン
#### 4.1.2 選定理由
#### 4.1.3 検討した代替案
#### 4.1.4 トレードオフ
### 4.2 技術スタック
#### 4.2.1 選定した技術
#### 4.2.2 選定理由（要件定義書との紐付け）
#### 4.2.3 検討した代替案
### 4.3 参照した技術標準（`.claude/docs/40_standards/`） ⭐⭐⭐
### 4.4 レイヤー構成
### 4.5 データフロー

## 5. システム構成図
### 5.1 全体構成図
### 5.2 ネットワーク構成図
### 5.3 コンポーネント配置図

## 6. データベース設計
### 6.1 ER図（詳細版）
### 6.2 テーブル一覧
### 6.3 インデックス戦略
### 6.4 選定理由（RDB vs NoSQL）

## 7. API設計
### 7.1 API設計方針
### 7.2 認証・認可方式
#### 7.2.1 選定した方式
#### 7.2.2 選定理由
### 7.3 エラーハンドリング方針
### 7.4 外部連携設計
#### 7.4.1 外部API仕様
#### 7.4.2 レート制限対策
### 7.5 API バージョニング戦略

## 8. セキュリティ設計
### 8.1 認証設計
### 8.2 認可設計
### 8.3 データ暗号化
### 8.4 シークレット管理
### 8.5 監査ログ
### 8.6 `.claude/docs/40_standards/49_security.md` 準拠確認 ⭐⭐⭐

## 9. 性能設計
### 9.1 性能要件の整理
### 9.2 レスポンスタイム目標値
### 9.3 スループット設計
### 9.4 ボトルネック分析と対策
### 9.5 負荷試験計画

## 10. 運用設計
### 10.1 監視設計
### 10.2 ログ設計
### 10.3 バックアップ設計
### 10.4 障害復旧設計（RTO/RPO）
### 10.5 障害対応フロー

## 11. インフラ設計
### 11.1 クラウドベンダー選定
#### 11.1.1 選定したベンダー
#### 11.1.2 選定理由
#### 11.1.3 検討した代替案
### 11.2 ネットワーク設計
### 11.3 コンピューティング設計
### 11.4 ストレージ設計
### 11.5 コスト設計
#### 11.5.1 インフラコスト試算
#### 11.5.2 運用コスト見積もり
#### 11.5.3 コスト最適化戦略
### 11.6 `.claude/docs/40_standards/45_cloudformation.md`/4.4 準拠確認 ⭐

## 12. 開発環境・CI/CD設計
### 12.1 開発環境構成
### 12.2 CI/CDパイプライン設計
### 12.3 デプロイ戦略（Blue/Green、Canary等）
### 12.4 環境分離戦略（dev/staging/production）

## 13. テスト戦略
### 13.1 テスト方針
### 13.2 テスト環境構成
### 13.3 テストデータ戦略
### 13.4 テスト自動化方針

## 14. マイグレーション計画（既存システムがある場合）
### 14.1 データ移行方針
### 14.2 段階的移行計画
### 14.3 ロールバック戦略
### 14.4 並行稼働期間

## 15. 非機能要件への対応
### 15.1 性能要件への対応（セクション9参照）
### 15.2 可用性要件への対応
### 15.3 セキュリティ要件への対応（セクション8参照）
### 15.4 運用要件への対応（セクション10参照）
### 15.5 拡張性要件への対応
```

---

## 📝 各セクションの記述方法

### 3. 制約事項・前提条件

**記載例:**
```markdown
## 3. 制約事項・前提条件

### 3.1 技術的制約
- **既存システムとの連携**: 既存の顧客管理システム（Java製）とREST APIで連携必須
- **使用必須技術**: 社内標準としてAWS利用が必須（GCP/Azure不可）
- **データベース**: PostgreSQL 14以上（既存システムとの互換性）

### 3.2 ビジネス制約
- **予算**: インフラコスト月10万円以内
- **納期**: 2025年12月末リリース（4ヶ月）
- **人員**: 開発チーム3名（バックエンド2名、フロントエンド1名）

### 3.3 外部依存
- **決済API**: Stripe（月間トランザクション上限10,000件）
- **メール送信**: SendGrid（月間送信数50,000通まで無料）
- **SMS送信**: Twilio（従量課金）

### 3.4 既存システムとの連携要件
- 既存システムから顧客情報をREST APIで取得（レスポンスタイム<500ms）
- 認証は既存システムのOAuth 2.0を利用
```

### 4. アーキテクチャ設計（理由・背景を含む）

**記載例:**
```markdown
## 4. アーキテクチャ設計

### 4.1 アーキテクチャパターン

#### 4.1.1 選定したパターン
**レイヤードアーキテクチャ + マイクロサービス（2サービス構成）**

- ユーザー管理サービス（認証・認可）
- 決済管理サービス（注文・決済）

#### 4.1.2 選定理由

**要件定義書との紐付け:**
- 非機能要件「将来的にサービスを独立してスケールさせたい」（要件定義書 3.2節）
- ユーザー管理と決済処理で負荷特性が大きく異なる
- 決済サービスのみPCI DSS準拠が必要

**技術的根拠:**
- ユーザー管理: 読み取り多（80%）、書き込み少（20%）
- 決済処理: トランザクション重視、書き込み多（60%）
- 独立したスケーリングで月間インフラコスト30%削減見込み

#### 4.1.3 検討した代替案

| パターン | メリット | デメリット | 不採用理由 |
|---------|---------|----------|-----------|
| モノリス | 開発速度速い、運用シンプル | スケーリング柔軟性低い | 要件定義の拡張性要件を満たせない |
| フルマイクロサービス（5+） | 最大の柔軟性 | 運用複雑、チーム3名では過剰 | チーム規模に対してオーバーエンジニアリング |
| サーバーレス | インフラ管理不要 | 既存システム連携が複雑 | 既存システムとの同期処理に不向き |

#### 4.1.4 トレードオフ

**メリット:**
- ✅ サービスごとに独立したスケーリング可能
- ✅ 決済サービスのみ強固なセキュリティ適用可能
- ✅ 障害の影響範囲を限定可能

**デメリット:**
- ❌ 分散トレーシング必要（AWS X-Ray導入）
- ❌ サービス間通信のレイテンシ（+50ms程度）
- ❌ 運用複雑化（監視対象2倍）

**判断:**
将来の拡張性を優先。レイテンシはキャッシュで吸収可能と判断。

### 4.2 技術スタック

#### 4.2.1 選定した技術

| レイヤー | 技術 |
|---------|------|
| バックエンド | Node.js 20 + Express |
| データベース | PostgreSQL 15 |
| インフラ | AWS ECS Fargate |
| CI/CD | GitHub Actions |

#### 4.2.2 選定理由（要件定義書との紐付け）

**Node.js 20 + Express**

要件との紐付け:
- 性能要件: 同時接続100ユーザー、レスポンス1秒以内（要件定義書 3.1節）
- 開発期間: 4ヶ月（要件定義書 1.3節）

選定理由:
- チーム全員がJavaScript/TypeScript経験あり（学習コスト0、開発速度最大化）
- npmエコシステムが豊富（Stripe SDK、SendGrid SDK等すぐ利用可能）
- 非同期I/O で外部API連携に強い（既存システム連携要件に適合）
- 性能要件を十分満たせる（Node.js単体で1000req/sec可能）

**PostgreSQL 15**

要件との紐付け:
- データ要件: トランザクション整合性必須（決済処理）（要件定義書 2.3節）
- 将来性: 将来的にデータ分析機能追加予定（要件定義書 4.2節）

選定理由:
- ACID特性でトランザクション整合性を保証（決済処理に必須）
- JSON型でNoSQL的な使い方も可能（将来の柔軟性）
- AWS RDS でマネージド運用可能（運用コスト削減）
- PostGIS拡張で将来の位置情報機能に対応可能

制約との整合性:
- 既存システムもPostgreSQL使用（データ移行容易）（制約事項 3.1節）

#### 4.2.3 検討した代替案

**バックエンド:**

| 技術 | メリット | デメリット | 不採用理由 |
|------|---------|----------|-----------|
| Python + FastAPI | 非同期処理強い | チーム経験者1名のみ | 学習コスト高、納期4ヶ月に間に合わない |
| Go | 性能最高、並行処理強い | 学習コスト高、エコシステム小 | チーム未経験、外部SDK少ない |
| Java + Spring Boot | エンタープライズ実績豊富 | 開発速度遅い、メモリ消費大 | 納期・インフラコストで不利 |

**データベース:**

| 技術 | メリット | デメリット | 不採用理由 |
|------|---------|----------|-----------|
| MySQL | 実績豊富、情報多い | トランザクション性能で劣る | 決済処理のトランザクション性能不安 |
| DynamoDB | スケーラビリティ最高 | トランザクション弱い | 決済処理のACID要件満たせない |
| MongoDB | スキーマレス、柔軟性高い | トランザクション弱い | 決済処理に不向き |

### 4.3 参照した技術標準（`.claude/docs/40_standards/`） ⭐⭐⭐

### 4.6 Node.js/TypeScript規約
- ディレクトリ構成: 技術標準に準拠
- linter: ESLint（技術標準推奨設定）
- formatter: Prettier（技術標準推奨設定）

### 4.9 セキュリティ・運用基準 ⭐⭐⭐
- 認証: JWT + bcrypt（技術標準推奨）
- 暗号化: TLS 1.3 + AES-256（技術標準推奨）
- シークレット管理: AWS Secrets Manager（技術標準推奨）
```

### 11. インフラ設計（コスト設計を含む）

**記載例:**
```markdown
## 11. インフラ設計

### 11.1 クラウドベンダー選定

#### 11.1.1 選定したベンダー
AWS（Amazon Web Services）

#### 11.1.2 選定理由

**制約事項との整合性:**
- 社内標準としてAWS利用が必須（制約事項 3.1節）

**技術的根拠:**
- ECS Fargateでコンテナ管理不要（運用コスト削減）
- RDS、Secrets Manager等のマネージドサービスが充実
- 既存システムもAWS上で稼働（ネットワーク統合容易）

#### 11.1.3 検討した代替案

| ベンダー | メリット | デメリット | 不採用理由 |
|---------|---------|----------|-----------|
| GCP | BigQuery安価 | 社内実績なし | 制約事項により不可 |
| Azure | Microsoftとの親和性 | コスト高 | 制約事項により不可 |

### 11.5 コスト設計

#### 11.5.1 インフラコスト試算

**前提条件:**
- ユーザー数: 1,000名（初年度）
- 同時接続: 最大100ユーザー（ピーク時）
- データ量: 100GB（初年度）

**コスト内訳（月額）:**

| リソース | スペック | 月額費用 | 根拠 |
|---------|---------|---------|------|
| ECS Fargate | 0.5 vCPU, 1GB RAM × 2タスク | $36 | (0.5 * 0.04048 + 1 * 0.004445) * 720h * 2 |
| RDS PostgreSQL | db.t4g.micro (Multi-AZ) | $28 | AWS料金表 |
| ALB | 2 LCU | $24 | 固定$16 + 処理$8 |
| CloudWatch Logs | 10GB/月 | $5 | $0.50/GB |
| Secrets Manager | 5シークレット | $2 | $0.40/シークレット |
| **合計** | | **$95** | 予算$100以内 ✅ |

**スケーリング時の試算:**

| ユーザー数 | ECS | RDS | 月額合計 | 備考 |
|----------|-----|-----|---------|------|
| 1,000名 | 2タスク | db.t4g.micro | $95 | 初年度 |
| 5,000名 | 4タスク | db.t4g.small | $210 | 2年目想定 |
| 10,000名 | 8タスク | db.t4g.medium | $450 | 3年目想定 |

#### 11.5.2 運用コスト見積もり

**人件費:**
- 運用担当: 1名 × 20時間/月 × @5,000円 = 10万円/月

**外部サービス:**
- Stripe: 3.6%手数料（月間売上100万円想定 → 36,000円/月）
- SendGrid: 無料枠内（50,000通/月）
- Twilio: 1万円/月（SMS 500通想定）

**合計運用コスト: 約15万円/月**

#### 11.5.3 コスト最適化戦略

**短期施策（3ヶ月以内）:**
- CloudWatch Logs保持期間を30日→7日に短縮（$5→$1.5、70%削減）
- 開発環境を夜間・休日停止（$36→$18、50%削減）

**中期施策（6ヶ月〜1年）:**
- RDS Reserved Instance購入（年間契約で30%割引）
- S3 Intelligent-Tiering導入（アクセス頻度低いデータ自動移行）

**長期施策（1年〜）:**
- Savings Plans検討（ECS Fargate で20%割引）
- スポットインスタンス活用（バッチ処理）
```

---

## 📁 ファイル分割の推奨

### 小規模プロジェクトの場合（推定300行以内）

```
docs/03_基本設計書.md      # 1ファイルでOK
```

### 中〜大規模プロジェクトの場合（推定300行超）

**推奨：# 見出し1（セクション）ごとにファイル分割**

```
docs/03_基本設計書/
├── README.md               # 目次・ナビゲーション
├── 00_概要.md              # はじめに、システム概要（短いため1ファイル）
├── 01_制約事項・前提条件.md
├── 02_アーキテクチャ設計.md
├── 03_システム構成図.md
├── 04_データベース設計.md
├── 05_API設計.md
├── 06_セキュリティ設計.md
├── 07_性能設計.md
├── 08_運用設計.md
├── 09_インフラ設計・コスト設計.md
├── 10_開発環境・CI_CD設計.md
├── 11_テスト戦略.md
├── 12_マイグレーション計画.md  # 既存システムがある場合のみ
└── 13_非機能要件対応.md
```

**理由:**
- ✅ 1ファイルあたり100〜300行程度に抑えられる
- ✅ セクションごとに独立して編集・レビュー可能
- ✅ Git差分が見やすい
- ✅ 複数人で並行作業しやすい

### ディレクトリ構成の例

```
docs/
├── 01_企画書.md
├── 02_要件定義書.md
├── 03_基本設計書/          # ディレクトリ化
│   ├── README.md           # 目次・ナビゲーション
│   ├── 00_概要.md
│   ├── 01_制約事項・前提条件.md
│   ├── 02_アーキテクチャ設計.md
│   ├── 03_システム構成図.md
│   ├── 04_データベース設計.md
│   ├── 05_API設計.md
│   ├── 06_セキュリティ設計.md
│   ├── 07_性能設計.md
│   ├── 08_運用設計.md
│   ├── 09_インフラ設計・コスト設計.md
│   ├── 10_開発環境・CI_CD設計.md
│   ├── 11_テスト戦略.md
│   ├── 12_マイグレーション計画.md
│   └── 13_非機能要件対応.md
└── 04_詳細設計書/
    └── ...
```

### README.md の例（ナビゲーション）

```markdown
# 基本設計書

## 目次

1. [概要](./00_概要.md) - はじめに、システム概要
2. [制約事項・前提条件](./01_制約事項・前提条件.md) - 技術的制約、ビジネス制約、外部依存
3. [アーキテクチャ設計](./02_アーキテクチャ設計.md) - アーキテクチャパターン、技術スタック（選定理由・代替案・トレードオフ含む）
4. [システム構成図](./03_システム構成図.md) - 全体構成、ネットワーク構成
5. [データベース設計](./04_データベース設計.md) - ER図、テーブル一覧、選定理由
6. [API設計](./05_API設計.md) - API設計方針、認証・認可、外部連携、バージョニング戦略
7. [セキュリティ設計](./06_セキュリティ設計.md) - 認証、暗号化、シークレット管理
8. [性能設計](./07_性能設計.md) - レスポンスタイム目標、スループット、ボトルネック分析
9. [運用設計](./08_運用設計.md) - 監視、ログ、バックアップ、障害復旧、障害対応フロー
10. [インフラ設計・コスト設計](./09_インフラ設計・コスト設計.md) - ベンダー選定、コスト試算、最適化戦略
11. [開発環境・CI/CD設計](./10_開発環境・CI_CD設計.md) - 開発環境、CI/CDパイプライン、デプロイ戦略
12. [テスト戦略](./11_テスト戦略.md) - テスト方針、テスト環境、テストデータ戦略
13. [マイグレーション計画](./12_マイグレーション計画.md) - データ移行、段階的移行、ロールバック
14. [非機能要件対応](./13_非機能要件対応.md) - 性能、可用性、運用要件への対応まとめ
```

### 判断基準

| プロジェクト規模 | ファイル構成 | 理由 |
|------------|----------|------|
| 小規模（〜300行） | 1ファイル | シンプル、管理しやすい |
| 中規模（300〜1000行） | セクション分割 | レビューしやすい、並行作業可能 |
| 大規模（1000行〜） | セクション分割 + サブセクション分割 | 必須（1ファイルでは管理不可能） |

### 設計書生成時の推奨フロー

1. **最初は1ファイルで生成**（`docs/03_基本設計書.md`）
2. **内容を確認**
   - 各セクションの内容が十分に詳細か確認
   - レビューしやすいか確認
3. **ファイル分割の判断**
   - セクションごとの内容が独立しているか確認
   - 分割するメリットがあるか確認
4. **ファイル分割実施**（必要に応じて）
   - ディレクトリ作成: `docs/03_基本設計書/`
   - セクションごとに分割
   - README.md でナビゲーション提供

---

**作成日**: 2025-10-19
**更新日**: 2025-10-22（理由・背景セクション追加、制約事項・性能設計・コスト設計・テスト戦略等を追加）
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 必須
