# 開発プロセスで必要なコア規約チェックリスト

## 1. 設計フェーズで必要な規約

### 1.1 アーキテクチャ設計規約
- [ ] **レイヤー分割方針**（Presentation / Application / Domain / Infrastructure）
- [ ] **モジュール分割方針**（モノリシック / マイクロサービス / モジュラーモノリス）
- [ ] **依存関係のルール**（上位層→下位層のみ、逆依存禁止）
- [ ] **境界づけられたコンテキスト**（DDD採用時）

### 1.2 データベース設計規約
- [ ] **命名規則**（テーブル名、カラム名、インデックス名）
- [ ] **正規化ルール**（第何正規形まで / 非正規化判断基準）
- [ ] **主キー設計**（UUID / Auto Increment / Natural Key）
- [ ] **外部キー制約**（ON DELETE / ON UPDATE の方針）
- [ ] **インデックス設計**（単一 / 複合 / ユニーク）
- [ ] **タイムスタンプ**（created_at / updated_at / deleted_at の必須化）
- [ ] **論理削除 vs 物理削除**
- [ ] **トランザクション分離レベル**
- [ ] **パーティショニング戦略**（大規模データ時）

### 1.3 API設計規約
- [ ] **API スタイル**（REST / GraphQL / gRPC）
- [ ] **バージョニング戦略**（/v1/ / クエリパラメータ / ヘッダー）
- [ ] **エンドポイント命名規則**（リソース指向 / 動詞禁止）
- [ ] **HTTPメソッド使い分け**（GET / POST / PUT / PATCH / DELETE）
- [ ] **ステータスコード定義**（200, 201, 400, 401, 403, 404, 500等）
- [ ] **リクエスト/レスポンスフォーマット**（JSON構造、ネストルール）
- [ ] **ペジネーション方式**（offset / cursor）
- [ ] **ソート・フィルタリング**（クエリパラメータ規約）
- [ ] **エラーレスポンス統一**（error code, message, details）
- [ ] **認証・認可**（JWT / OAuth2 / API Key）
- [ ] **レート制限**（API制限数、429エラー）

### 1.4 セキュリティ設計規約
- [ ] **認証方式**（JWT / Session / OAuth2）
- [ ] **認可方式**（RBAC / ABAC）
- [ ] **パスワードポリシー**（長さ、複雑さ、有効期限）
- [ ] **暗号化方針**（通信：TLS / データ：AES / パスワード：bcrypt）
- [ ] **機密情報管理**（Secrets Manager / 環境変数 / KMS）
- [ ] **アクセスログ記録**（誰が・いつ・何を）
- [ ] **CORS設定**
- [ ] **CSRF対策**
- [ ] **XSS対策**
- [ ] **SQLインジェクション対策**（プリペアドステートメント）
- [ ] **個人情報取り扱い**（GDPR / 個人情報保護法対応）

---

## 2. 実装フェーズで必要な規約

### 2.1 ディレクトリ構造規約
- [ ] **ディレクトリ命名規則**（複数形 / 単数形 / ケバブケース / スネークケース）
- [ ] **レイヤー別ディレクトリ分割**（controllers / services / repositories）
- [ ] **機能別 vs レイヤー別**（どちらで分けるか）
- [ ] **共通処理の配置場所**（utils / helpers / common）
- [ ] **設定ファイルの配置**（config / env）
- [ ] **テストファイルの配置**（同一ディレクトリ / tests/ 配下）

### 2.2 ファイル命名規約
- [ ] **ファイル名形式**（キャメルケース / パスカルケース / ケバブケース）
- [ ] **拡張子**（.ts / .tsx / .js / .jsx）
- [ ] **テストファイル**（*.test.ts / *.spec.ts）
- [ ] **型定義ファイル**（*.types.ts / *.d.ts）

### 2.3 コーディング規約（共通）
- [ ] **インデント**（2スペース / 4スペース / タブ）
- [ ] **改行コード**（LF / CRLF）
- [ ] **文字コード**（UTF-8）
- [ ] **行の最大長**（80文字 / 100文字 / 120文字）
- [ ] **セミコロン**（必須 / 不要）
- [ ] **クォート**（シングル / ダブル）
- [ ] **末尾カンマ**（trailing comma: あり / なし）

### 2.4 コーディング規約（バックエンド）
- [ ] **関数命名**（動詞 + 名詞：createUser / getUserById）
- [ ] **変数命名**（キャメルケース / 意味のある名前）
- [ ] **定数命名**（UPPER_SNAKE_CASE）
- [ ] **クラス命名**（パスカルケース）
- [ ] **非同期処理**（async/await / Promise）
- [ ] **エラーハンドリング**（try-catch必須 / カスタムエラークラス）
- [ ] **ログ出力**（レベル：DEBUG / INFO / WARN / ERROR / FATAL）
- [ ] **コメント**（JSDoc / 関数説明必須）
- [ ] **型定義**（TypeScript strict mode / any禁止）
- [ ] **環境変数**（.env管理 / 必須変数バリデーション）
- [ ] **依存性注入**（DI コンテナ使用 / 手動注入）

### 2.5 コーディング規約（フロントエンド）
- [ ] **コンポーネント命名**（パスカルケース：UserProfile）
- [ ] **Props 型定義**（interface / type）
- [ ] **状態管理**（useState / Context / Redux / Recoil）
- [ ] **副作用管理**（useEffect / React Query / SWR）
- [ ] **スタイリング**（CSS Modules / Styled Components / Tailwind）
- [ ] **イベントハンドラ命名**（handleClick / onClickButton）
- [ ] **条件付きレンダリング**（三項演算子 / && / if文）
- [ ] **ループ処理**（map / filter / reduce）
- [ ] **アクセシビリティ**（aria属性 / semantic HTML）

### 2.6 コード品質規約
- [ ] **関数の最大行数**（50行以内推奨）
- [ ] **クラスの最大行数**（200行以内推奨）
- [ ] **ネストの最大深さ**（3階層まで）
- [ ] **循環的複雑度**（10以下推奨）
- [ ] **重複コードの削減**（DRY原則）
- [ ] **単一責任の原則**（SRP）
- [ ] **マジックナンバー禁止**（定数化）

### 2.7 Git 運用規約
- [ ] **ブランチ戦略**（Git Flow / GitHub Flow / GitLab Flow）
- [ ] **ブランチ命名**（feature/ / bugfix/ / hotfix/）
- [ ] **コミットメッセージ**（Conventional Commits / prefix付き）
- [ ] **コミット粒度**（1機能1コミット / Atomic Commit）
- [ ] **Pull Request ルール**（レビュー必須 / テスト通過必須）
- [ ] **マージ方法**（Squash / Merge Commit / Rebase）

---

## 3. テストフェーズで必要な規約

### 3.1 テスト設計規約（全体）
- [ ] **テストレベル定義**（単体 / 結合 / システム / 受入）
- [ ] **テストカバレッジ目標**（各レベルごとに設定）
- [ ] **テストケース設計方法**（同値分割 / 境界値分析 / デシジョンテーブル）
- [ ] **テストデータ管理**（Fixture / Factory / Seed / マスキング）
- [ ] **テスト環境構成**（専用DB / 専用インフラ / データ分離）

### 3.2 単体テスト（Unit Test）規約
- [ ] **テスト対象範囲**（関数 / メソッド / クラス単位）
- [ ] **テストカバレッジ目標**（80%以上推奨）
- [ ] **テストケース**
  - [ ] 正常系（Happy Path）
  - [ ] 異常系（エラーケース）
  - [ ] 境界値（最小値 / 最大値 / null / 空文字）
- [ ] **モック・スタブ使用**（外部依存は必ずモック化）
- [ ] **テストの独立性**（他テストに依存しない / 順序不問）
- [ ] **テストファイル配置**（*.test.ts / 対象ファイルと同じディレクトリ）
- [ ] **テストケース命名**（describe / it / test）
- [ ] **Arrange-Act-Assert パターン**（準備 / 実行 / 検証）

**例：**
```typescript
describe('UserService', () => {
  describe('createUser', () => {
    it('正常系：新規ユーザーを作成できる', async () => {
      // Arrange
      const userData = { name: '田中太郎', email: 'tanaka@example.com' };

      // Act
      const user = await userService.createUser(userData);

      // Assert
      expect(user.id).toBeDefined();
      expect(user.name).toBe('田中太郎');
    });

    it('異常系：メールアドレスが重複している場合、エラーを返す', async () => {
      // ...
    });

    it('境界値：名前が空文字の場合、バリデーションエラー', async () => {
      // ...
    });
  });
});
```

### 3.3 結合テスト（Integration Test）規約
- [ ] **テスト対象範囲**（複数モジュール / DB連携 / 外部API連携）
- [ ] **テストカバレッジ目標**（主要フロー100%）
- [ ] **テストケース**
  - [ ] モジュール間連携（Controller → Service → Repository）
  - [ ] データベース連携（CRUD / トランザクション）
  - [ ] 外部API連携（HTTPリクエスト / レスポンス）
  - [ ] メッセージキュー連携（SQS / Kafka）
- [ ] **テストデータベース**（専用DB使用 / テスト前後でクリーンアップ）
- [ ] **外部API**（モックサーバー / スタブ / Wiremock）
- [ ] **トランザクションテスト**（コミット / ロールバック）
- [ ] **並行処理テスト**（排他制御 / デッドロック）

**例：**
```typescript
describe('User Registration Flow (Integration)', () => {
  beforeEach(async () => {
    // テストDB初期化
    await testDB.clean();
  });

  it('正常系：ユーザー登録 → メール送信 → DB保存', async () => {
    // Arrange
    const userData = { name: '田中太郎', email: 'tanaka@example.com' };

    // Act
    const response = await request(app)
      .post('/api/v1/users')
      .send(userData);

    // Assert
    expect(response.status).toBe(201);

    // DB確認
    const user = await userRepository.findByEmail('tanaka@example.com');
    expect(user).toBeDefined();

    // メール送信確認（モック）
    expect(emailService.send).toHaveBeenCalledWith({
      to: 'tanaka@example.com',
      subject: 'アカウント登録完了',
    });
  });
});
```

### 3.4 システムテスト（System Test / E2E Test）規約
- [ ] **テスト対象範囲**（システム全体 / ユーザーシナリオ）
- [ ] **テストカバレッジ目標**（主要ユースケース100%）
- [ ] **テストケース**
  - [ ] 主要ユースケース（ログイン → データ登録 → 検索 → 更新 → 削除）
  - [ ] クロスブラウザテスト（Chrome / Firefox / Safari / Edge）
  - [ ] レスポンシブデザイン（PC / タブレット / スマホ）
  - [ ] パフォーマンステスト（応答時間 / 負荷）
- [ ] **E2E ツール**（Playwright / Cypress / Selenium）
- [ ] **テスト環境**（ステージング環境 / 本番相当）
- [ ] **テストデータ**（毎回クリーンアップ / Fixture投入）
- [ ] **待機処理**（明示的待機 / タイムアウト設定）
- [ ] **スクリーンショット**（エラー時に自動取得）

**例：**
```typescript
describe('User Registration E2E', () => {
  it('ユーザー登録フロー', async () => {
    // 1. トップページにアクセス
    await page.goto('https://example.com');

    // 2. 新規登録ボタンをクリック
    await page.click('button:has-text("新規登録")');

    // 3. フォーム入力
    await page.fill('input[name="name"]', '田中太郎');
    await page.fill('input[name="email"]', 'tanaka@example.com');
    await page.fill('input[name="password"]', 'SecurePass123!');

    // 4. 登録ボタンクリック
    await page.click('button:has-text("登録")');

    // 5. 完了メッセージ確認
    await expect(page.locator('text=登録が完了しました')).toBeVisible();
  });
});
```

### 3.5 受入テスト（UAT: User Acceptance Test）規約
- [ ] **テスト対象**（ビジネス要件 / ユーザー要求）
- [ ] **テスト実施者**（ユーザー / ビジネス担当者）
- [ ] **テストシナリオ**（実際の業務フロー）
- [ ] **受入基準**（要件定義書の項目を満たすこと）
- [ ] **テスト環境**（本番相当 / ユーザーアクセス可能）
- [ ] **バグ管理**（重大度：Critical / High / Medium / Low）

### 3.6 パフォーマンステスト規約
- [ ] **負荷テスト**（想定ユーザー数 / 同時接続数）
- [ ] **ストレステスト**（限界値の確認）
- [ ] **スパイクテスト**（急激な負荷増加）
- [ ] **耐久テスト**（長時間稼働でのメモリリーク確認）
- [ ] **ツール**（JMeter / k6 / Artillery / Gatling）
- [ ] **測定項目**
  - [ ] レスポンスタイム（平均 / 95パーセンタイル / 99パーセンタイル）
  - [ ] スループット（RPS: Requests Per Second）
  - [ ] エラー率（5xx / 4xx）
  - [ ] リソース使用率（CPU / メモリ / ネットワーク）
- [ ] **合格基準**（例：応答時間2秒以内、エラー率1%以下）

### 3.7 セキュリティテスト規約
- [ ] **脆弱性スキャン**（OWASP ZAP / Burp Suite）
- [ ] **認証・認可テスト**（不正アクセス / 権限昇格）
- [ ] **SQLインジェクション**（プリペアドステートメント確認）
- [ ] **XSS（Cross-Site Scripting）**（エスケープ処理確認）
- [ ] **CSRF（Cross-Site Request Forgery）**（トークン確認）
- [ ] **機密情報漏洩**（ログ / エラーメッセージ）
- [ ] **依存関係の脆弱性**（npm audit / Snyk）

### 3.8 リグレッションテスト規約
- [ ] **テスト対象**（既存機能の動作確認）
- [ ] **自動化必須**（CI/CDパイプラインで自動実行）
- [ ] **テストケース管理**（変更時に追加・更新）
- [ ] **実施タイミング**（新機能追加時 / バグ修正時 / リファクタリング時）

---

## 4. 障害・可用性テスト規約

### 4.1 障害テスト（Fault Injection / Chaos Engineering）
- [ ] **テスト対象**（障害時の動作確認）
- [ ] **テストケース**
  - [ ] サーバーダウン（EC2 / ECS タスク停止）
  - [ ] ネットワーク遅延・切断
  - [ ] データベース接続断
  - [ ] ディスク容量枯渇
  - [ ] メモリ不足
  - [ ] 外部API障害
- [ ] **ツール**（AWS FIS / Chaos Monkey / Gremlin）
- [ ] **確認項目**
  - [ ] エラーハンドリング（適切なエラーメッセージ）
  - [ ] リトライ処理（自動復旧）
  - [ ] フェイルオーバー（冗長構成への切り替え）
  - [ ] ログ出力（障害の記録）
  - [ ] アラート通知（Slack / メール）

### 4.2 可用性テスト（Availability Test）
- [ ] **稼働率目標**（99.9% / 99.99%）
- [ ] **ダウンタイム許容**（月間〇分以内）
- [ ] **テストケース**
  - [ ] Multi-AZ構成の動作確認
  - [ ] Auto Scaling の動作確認
  - [ ] ヘルスチェックの動作確認
  - [ ] ロードバランサーの動作確認
- [ ] **計測期間**（30日間連続稼働）

### 4.3 復旧テスト（Disaster Recovery Test）
- [ ] **RTO（Recovery Time Objective）**（目標復旧時間：〇時間以内）
- [ ] **RPO（Recovery Point Objective）**（目標復旧時点：〇分前まで）
- [ ] **テストケース**
  - [ ] データベースバックアップからの復元
  - [ ] スナップショットからの復元
  - [ ] リージョン障害時の別リージョンへの切り替え
  - [ ] ロールバック（前バージョンへの戻し）
- [ ] **実施頻度**（四半期に1回 / 半年に1回）

### 4.4 バックアップテスト
- [ ] **バックアップ対象**（DB / ファイル / 設定）
- [ ] **バックアップ頻度**（日次 / 週次）
- [ ] **バックアップ保持期間**（30日 / 90日）
- [ ] **リストアテスト**（バックアップから復元できることを確認）
- [ ] **実施頻度**（月次）

---

## 4. デプロイ・運用フェーズで必要な規約

### 4.1 CI/CD 規約
- [ ] **CI/CD ツール**（GitHub Actions / GitLab CI / CircleCI）
- [ ] **パイプライン構成**（ビルド → テスト → デプロイ）
- [ ] **環境別デプロイフロー**（dev → stg → prod）
- [ ] **デプロイ承認フロー**（手動承認 / 自動デプロイ）
- [ ] **ロールバック戦略**（前バージョンに戻す / Blue-Green）

### 4.2 インフラ規約
- [ ] **IaC ツール**（Terraform / CloudFormation / CDK）
- [ ] **リソース命名規則**（{project}-{env}-{resource}-{number}）
- [ ] **タグ戦略**（Name / Environment / ManagedBy / CostCenter）
- [ ] **環境分離**（dev / stg / prod の VPC分離）
- [ ] **ネットワーク設計**（CIDR設計 / サブネット分割）
- [ ] **セキュリティグループ設計**（最小権限 / ポート制限）
- [ ] **スケーリング戦略**（Auto Scaling / 閾値設定）

### 4.3 モニタリング・ログ規約
- [ ] **ログレベル定義**（DEBUG / INFO / WARN / ERROR / FATAL）
- [ ] **ログフォーマット**（JSON / 構造化ログ）
- [ ] **ログ出力先**（CloudWatch / S3 / Elasticsearch）
- [ ] **ログ保持期間**（アプリログ30日 / アクセスログ90日）
- [ ] **メトリクス収集**（CPU / メモリ / ディスク / ネットワーク）
- [ ] **アラート設定**（閾値 / 通知先：Slack / メール）
- [ ] **分散トレーシング**（X-Ray / Jaeger / Zipkin）

### 4.4 運用規約
- [ ] **デプロイ手順書**
- [ ] **障害対応手順**（エスカレーションフロー）
- [ ] **バックアップ戦略**（日次 / 週次 / 世代管理）
- [ ] **リカバリ手順**（RTO / RPO 定義）
- [ ] **定期メンテナンス**（パッチ適用 / ログローテーション）

---

## 5. ドキュメント規約

### 5.1 ドキュメント作成規約
- [ ] **README.md 必須項目**（プロジェクト概要 / セットアップ / 使い方）
- [ ] **ADR（Architecture Decision Records）**（重要な技術判断の記録）
- [ ] **API ドキュメント**（OpenAPI / Swagger）
- [ ] **ER図**（Mermaid / draw.io）
- [ ] **システム構成図**（Mermaid / AWS Architecture Diagram）
- [ ] **シーケンス図**（主要フロー）

### 5.2 コードコメント規約
- [ ] **関数コメント**（JSDoc / PHPDoc / Docstring）
- [ ] **クラスコメント**（責務・使い方）
- [ ] **複雑なロジック**（Why（なぜ）を書く、What（何）は書かない）
- [ ] **TODO コメント**（TODO: / FIXME: / HACK:）

---

## 6. セキュリティ・コンプライアンス規約

### 6.1 コードセキュリティ
- [ ] **依存関係の脆弱性チェック**（npm audit / Snyk / Dependabot）
- [ ] **静的解析**（SonarQube / ESLint security plugin）
- [ ] **シークレットスキャン**（git-secrets / TruffleHog）
- [ ] **コードレビュー**（セキュリティ観点）

### 6.2 コンプライアンス
- [ ] **ライセンス管理**（使用OSSのライセンス確認）
- [ ] **個人情報取り扱い**（GDPR / 個人情報保護法）
- [ ] **アクセスログ記録**（監査証跡）
- [ ] **データ保持期間**（法定保存期間遵守）

---

## まとめ

### 最小限必要な規約（Phase 1）
1. **データベース設計規約**
2. **API設計規約**
3. **コーディング規約**
4. **Git運用規約**
5. **テスト設計規約**
6. **インフラ規約**
7. **モニタリング・ログ規約**

### 段階的に追加する規約（Phase 2以降）
- アーキテクチャ設計規約
- セキュリティ設計規約
- ADR（技術判断記録）
- E2Eテスト規約
- コードセキュリティ規約

---

## Claude の責務

各フェーズで、このチェックリストを参照し、必要な規約を生成・適用してください。
