# Check Command - コード品質チェック

## 概要

生成されたファイル（コード、ドキュメント等）の品質をチェックします。

**プロジェクト構造に依存しない汎用的なチェック:**
- 設計書がなくてもチェック可能
- 要件定義書がなくてもチェック可能
- 技術標準ファイルがなくてもチェック可能
- **あるものだけを使ってチェックする**

---

## コマンド一覧

```bash
# 最近生成したファイルをチェック
/check

# すべての生成物を一括チェック
/check all

# 特定のファイルをチェック
/check <file-path>

# 特定のディレクトリ配下をチェック
/check <directory-path>
```

---

## チェックの仕組み

### ステップ1: プロジェクト構造の検出

以下の順序で参照可能な基準を探します：

```
1. 技術標準ファイルの探索
   → `.claude/docs/40_standards/` があるか？
   → なければ一般的なベストプラクティスを使用

2. 設計書の探索
   → `docs/04_詳細設計書.md` があるか？
   → `docs/03_基本設計書.md` があるか？
   → `README.md` に設計情報があるか？
   → なければ「設計書なし」として扱う

3. 要件定義書の探索
   → `docs/02_要件定義書.md` があるか？
   → `docs/requirements.md` があるか？
   → なければ「要件定義書なし」として扱う

4. プロジェクト固有規約の探索
   → `docs/standards/` があるか？
   → `.eslintrc.json`, `.prettierrc` 等の設定ファイルがあるか？
```

### ステップ2: チェック基準の決定

**検出された基準のみを使用してチェック**

| 検出されたもの | チェック基準 |
|------------|------------|
| 技術標準 + 設計書 + 要件定義書 | すべて使用（最も厳密） |
| 技術標準 + 設計書 | 技術標準と設計書のみ使用 |
| 技術標準のみ | 技術標準のみ使用 |
| なし | 一般的なベストプラクティスのみ |

### ステップ3: チェック実行

検出された基準に基づいてチェック実行

---

## チェック基準（優先順位順）

### 1️⃣ ユーザー要望（最優先）

**参照:**
- `docs/02_要件定義書.md`（存在する場合）
- `docs/requirements.md`（存在する場合）
- `README.md`（存在する場合）

**チェック内容:**
- 機能要件を満たしているか
- 非機能要件を満たしているか

**要件定義書が存在しない場合:**
→ このチェックをスキップ（警告なし）

---

### 2️⃣ 設計書（構成・内容）

**参照:**
- `docs/04_詳細設計書.md` または `docs/04_詳細設計書/`
- `docs/03_基本設計書.md`
- `README.md` の設計情報

#### A. 構成チェック（ドキュメント構造）

**チェック内容:**

1. **ファイル分割の適切性**
   - 300行以内 → ✅ OK（1ファイルでOK）
   - 300〜1000行 → ⚠️ 警告（セクション分割推奨）
   - 1000行超 → ❌ エラー（必ず分割が必要）

2. **必須セクションの存在**
   - 詳細設計書に「## 10. 実装方針」セクションがあるか
   - 実装方針に以下のサブセクションがあるか：
     - 10.1 ファイル分割方針
     - 10.2 ディレクトリ構成
     - 10.3 モジュール分割
     - 10.4 命名規則
     - 10.5 技術標準の適用
     - 10.6 推定行数と分割理由

3. **ドキュメント品質**
   - 図（Mermaid）が含まれているか
   - 具体的な例が記載されているか

**構成チェックの例:**
```
📁 ドキュメント構成チェック

docs/04_詳細設計書.md: 1,983行
⚠️ 警告: 1000行超過（セクション分割が必須）

推奨構成:
docs/04_詳細設計書/
├── README.md              # ナビゲーション
├── 00_概要.md
├── 01_モジュール設計.md
├── 02_クラス設計.md
├── 03_API仕様書.md
├── 04_データベース設計.md
└── 09_実装方針.md         # 必須

参照: .claude/docs/10_facilitation/2.3_設計フェーズ/2.3.6_製造物_詳細設計書構成.md
```

```
❌ 必須セクション不足

「## 10. 実装方針」セクション: 見つかりませんでした

このセクションは必須です。
実装方針がないと、技術標準が守られないコードが生成されます。

推奨アクション:
1. 設計書に「## 10. 実装方針」セクションを追加
2. 以下の内容を記載：
   - ファイル分割方針
   - ディレクトリ構成
   - 推定行数と分割理由
   - 技術標準への参照

参照: .claude/docs/10_facilitation/2.3_設計フェーズ/2.3.7_実装方針設計.md
```

#### B. 内容チェック（実装方針との整合性）

**チェック内容:**
- ファイル分割方針に従っているか
- ディレクトリ構成に従っているか
- 命名規則に従っているか
- 推定行数と実際の行数が大きく乖離していないか

**設計書が存在しない場合:**
→ 構成・内容チェックの両方をスキップ（警告あり）

**警告メッセージ例:**
```
⚠️ 設計書が見つかりませんでした

設計書があると、以下をチェックできます：
- ドキュメント構成の適切性
- 必須セクションの存在
- ファイル分割方針との整合性
- 実装方針との整合性

推奨アクション:
- 詳細設計書を作成し、「## 10. 実装方針」セクションを追加
- 参照: .claude/docs/10_facilitation/2.3_設計フェーズ/2.3.7_実装方針設計.md
```

---

### 3️⃣ 技術標準

**参照:**
1. プロジェクト内の技術標準（優先）
   - `.claude/docs/40_standards/`

2. 一般的なベストプラクティス（フォールバック）
   - ファイルサイズ: 300行以内推奨
   - 関数サイズ: 50行以内推奨
   - ネストの深さ: 4階層以内推奨
   - セキュリティ: ハードコード禁止、環境変数使用

**チェック内容:**
- ファイル種別に応じた技術標準を適用
- ベストプラクティスに従っているか

**技術標準ファイルが存在しない場合:**
→ 一般的なベストプラクティスでチェック（警告あり）

**警告メッセージ例:**
```
⚠️ プロジェクト固有の技術標準が見つかりませんでした
一般的なベストプラクティスでチェックします。

より厳密なチェックを行うには:
- .claude/docs/40_standards/ に技術標準ファイルを追加
```

---

### 4️⃣ プロジェクト固有規約

**参照:**
- `docs/standards/`
- `.eslintrc.json`, `.prettierrc`, `tsconfig.json` 等の設定ファイル

**チェック内容:**
- プロジェクトで決めた独自ルールに従っているか

**プロジェクト固有規約が存在しない場合:**
→ このチェックをスキップ（警告なし）

---

## チェック対象ファイルと判定基準

### CloudFormation (`*.yaml`, `*.yml`)

#### 基本チェック（常に実施）

| 項目 | 基準 | 判定 |
|------|------|------|
| ファイルサイズ | 300行以内推奨 | ⚠️ 警告 |
| ハードコード | AWSアカウントID、シークレット禁止 | ❌ エラー |
| パラメータ化 | Environment、ProjectName等 | ⚠️ 警告 |
| タグ | Name、Environment、ManagedBy | ⚠️ 警告 |

#### 技術標準ありの場合（追加チェック）

| 項目 | 基準 | 判定 |
|------|------|------|
| ディレクトリ構造 | stacks/ templates/ parameters/ 構成 | ⚠️ 警告 |
| スタック分割 | ライフサイクル別分割（network/storage/compute） | ⚠️ 警告 |
| 環境差分集約 | parameters/*.json に集約 | ⚠️ 警告 |
| Change Sets | dry-run必須の記載 | ⚠️ 警告 |
| 命名規則 | 技術標準に準拠 | ⚠️ 警告 |
| Well-Architected | 6つの柱への対応 | ⚠️ 警告 |

**構成チェックの例:**
```
📁 CloudFormationディレクトリ構成チェック

現在の構成:
infra/
└── cloudformation/
    ├── network.yaml
    ├── database.yaml
    └── compute.yaml (752行)

⚠️ 推奨構成に従っていません

推奨構成（技術標準より）:
infra/cloudformation/
├── stacks/              # ライフサイクル別スタック定義
│   ├── network/
│   ├── storage/
│   └── compute/
├── templates/           # 再利用可能テンプレート
└── parameters/          # 環境差分を集約
    ├── dev.json
    └── prod.json

メリット:
- スタック分割で変更影響を最小化
- 環境差分が1箇所に集約
- 疎結合・責任分離

参照: .claude/docs/40_standards/45_cloudformation.md
```

#### 設計書ありの場合（追加チェック）

| 項目 | 基準 | 判定 |
|------|------|------|
| ファイル分割方針 | 設計書の方針に準拠 | ❌ エラー |
| 推定行数 | 設計書の推定行数±20% | ⚠️ 警告 |
| 分割理由 | 300行超える場合、設計書に理由記載 | ❌ エラー |

---

### Python (`*.py`)

#### 基本チェック（常に実施）

| 項目 | 基準 | 判定 |
|------|------|------|
| ファイルサイズ | 300行以内推奨 | ⚠️ 警告 |
| 関数サイズ | 50行以内推奨 | ⚠️ 警告 |
| ハードコード | APIキー、パスワード禁止 | ❌ エラー |

#### 技術標準ありの場合（追加チェック）

技術標準ファイル (`.claude/docs/40_standards/41_python.md`) に基づく詳細チェック

---

### TypeScript/JavaScript (`*.ts`, `*.tsx`, `*.js`, `*.jsx`)

#### 基本チェック（常に実施）

| 項目 | 基準 | 判定 |
|------|------|------|
| ファイルサイズ | 300行以内推奨 | ⚠️ 警告 |
| 関数サイズ | 50行以内推奨 | ⚠️ 警告 |
| ハードコード | APIキー、シークレット禁止 | ❌ エラー |

#### 技術標準ありの場合（追加チェック）

技術標準ファイル (`.claude/docs/40_standards/42_typescript.md`) に基づく詳細チェック

---

## 出力フォーマット

### `/check` - 基本出力

```markdown
# 📋 品質チェック結果

## 📂 プロジェクト構造の検出

✅ 技術標準: `.claude/docs/40_standards/45_cloudformation.md` を検出
⚠️ 設計書: 見つかりませんでした
⚠️ 要件定義書: 見つかりませんでした

## 🎯 チェック基準

**技術標準のみ**を使用してチェックします。

より厳密なチェックを行うには:
1. 詳細設計書を作成し、「## 10. 実装方針」セクションを追加
2. 要件定義書を作成

---

## ✅ チェック対象ファイル

- `infra/service/03-compute.yaml` (752行)

---

## 1️⃣ ユーザー要望チェック（スキップ）

⚠️ 要件定義書が見つからないため、スキップしました。

---

## 2️⃣ 設計書チェック（スキップ）

⚠️ 設計書が見つからないため、スキップしました。

**設計書があれば以下をチェックできます:**
- ファイル分割方針との整合性
- 推定行数との整合性
- 300行超える理由の説明

---

## 3️⃣ 技術標準チェック

### infra/service/03-compute.yaml

❌ **ファイルサイズ違反**
- 実際: 752行
- 基準: 300行以内推奨
- 超過: 452行（151%）

**判定:** ⚠️ 警告
**理由:** 設計書が存在しないため、300行超える理由が確認できません

**推奨アクション（いずれか）:**
1. ファイルを分割する
   - 例: `03-compute.yaml` (親スタック) + `nested/ecs.yaml` + `nested/alb.yaml`
2. 設計書を作成し、752行の合理的理由を記載
   - 例: 「ECS関連リソースは密結合のため、1ファイル管理が適切」

---

✅ **パラメータ化**
- Environment, ProjectName パラメータを使用

✅ **タグ付け**
- すべてのリソースに Name, Environment タグを付与

⚠️ **ハードコードチェック**
- AWSアカウントID、シークレットのハードコードは検出されませんでした

---

## 📊 総合判定

| 基準 | 判定 | 詳細 |
|------|------|------|
| 1️⃣ ユーザー要望 | ⏭️ スキップ | 要件定義書なし |
| 2️⃣ 設計書 | ⏭️ スキップ | 設計書なし |
| 3️⃣ 技術標準 | ⚠️ 警告 | ファイルサイズ超過 |
| 4️⃣ プロジェクト固有規約 | ⏭️ スキップ | 規約なし |

**総合判定: ⚠️ 改善推奨**

---

## 🔧 次のアクション

### 即座に実施すべきこと

1. **ファイル分割の検討**
   - `03-compute.yaml` (752行) を分割

### 今後実施すべきこと

1. **設計書の作成**
   - ファイル分割方針を明記
   - 300行超える場合の理由を記載

2. **要件定義書の作成**（オプション）
   - 機能要件を明記

---

## 💡 参考情報

### 設計書の作成方法

参照: `.claude/docs/10_facilitation/2.3_設計フェーズ/2.3.7_実装方針設計.md`

### 技術標準の詳細

参照: `.claude/docs/40_standards/45_cloudformation.md`
```

---

## `/check all` - 全体チェック出力

```markdown
# 📋 プロジェクト全体品質チェック

## 📂 プロジェクト構造の検出

✅ 技術標準: `.claude/docs/40_standards/` を検出
✅ 設計書: `docs/04_詳細設計書.md` を検出
✅ 要件定義書: `docs/02_要件定義書.md` を検出

## 🎯 チェック基準

**すべての基準**を使用してチェックします（最も厳密）。

---

## ✅ チェック対象ファイル（15ファイル）

### CloudFormation (6ファイル)
- infra/platform/stack.yaml (214行)
- infra/service/01-network.yaml (245行)
- infra/service/02-database.yaml (352行)
- infra/service/03-compute.yaml (752行) ⚠️

### ドキュメント (6ファイル)
- docs/01_企画書.md
- docs/02_要件定義書.md (824行)
- docs/03_基本設計書.md
- docs/04_詳細設計書.md (1,983行)

### アプリケーション (3ファイル)
- src/index.ts (120行)
- src/services/user.service.ts (180行)
- src/repositories/user.repository.ts (150行)

---

## 📊 チェック結果サマリー

| ファイル種別 | 総数 | ✅ 適合 | ⚠️ 警告 | ❌ エラー |
|------------|------|---------|---------|---------|
| CloudFormation | 6 | 5 | 1 | 0 |
| ドキュメント | 6 | 6 | 0 | 0 |
| TypeScript | 3 | 3 | 0 | 0 |
| **合計** | **15** | **14** | **1** | **0** |

**適合率: 93.3% (14/15)**

---

## ⚠️ 問題のあるファイル

### 1. infra/service/03-compute.yaml (752行)

**問題:**
- ファイルサイズ: 752行（基準: 300行以内）
- 設計書の推定: 180行（実際との差: +572行、318%）
- 設計書の方針: 「ネスト構成に分割」

**判定:** ❌ エラー（設計書の方針に従っていない）

**推奨アクション:**
設計書通りにネスト構成に分割してください：
- `03-compute.yaml` (親スタック、180行程度)
- `nested/ecs.yaml` (ECS Cluster、280行程度)
- `nested/alb.yaml` (ALB、220行程度)

---

## 🎯 総合判定

✅ 要件定義: すべての機能要件を満たしている
❌ 設計書: 1ファイルが設計方針に従っていない
✅ 技術標準: 基準を満たしている（設計書の問題を除く）
✅ セキュリティ: ハードコード、暗号化等すべて適合

**総合判定: ⚠️ 修正必要（1ファイル）**

---

## 🔧 次のアクション

### 即座に実施すべきこと

1. **03-compute.yaml をネスト構成に分割**
   - 設計書（詳細設計書 3.1節）に記載された方針に従う

### 今後実施すべきこと

なし（他のファイルはすべて適合）
```

---

## `/check <file-path>` - 個別ファイル詳細チェック

特定ファイルの詳細チェック結果を行番号付きで表示

---

## 自動実行

Claude は以下のタイミングで自動的に `/check` を**提案**します：

1. **ファイル生成後**（自動実行はしない）
   - 「生成しました。`/check` で品質確認しますか？」

2. **タスク完了時**（自動実行はしない）
   - 「タスク完了しました。`/check all` で全体確認しますか？」

**重要:** ユーザーが明示的に実行するまで自動実行しません。
レビューは人間が主導すべきです。

---

## まとめ

### `/check` コマンドの特徴

1. **プロジェクト構造に依存しない**
   - 設計書がなくてもチェック可能
   - 技術標準がなくてもチェック可能
   - あるものだけを使ってチェック

2. **段階的なチェック**
   - 基本チェック（常に実施）
   - 技術標準チェック（技術標準がある場合）
   - 設計書チェック（設計書がある場合）

3. **明確な優先順位**
   - ユーザー要望 > 設計書 > 技術標準
   - 技術標準はガイドライン

4. **人間主導のレビュー**
   - 自動実行しない
   - レビューできる人が使って強力になる

---

**作成日**: 2025-10-21
**更新日**: 2025-10-21（汎用的チェックに全面改訂）
